<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>PickAI OCR Test</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 18px; }
    #ocrResult { margin-top: 12px; font-family: monospace; color: #0f0; }
    #answer { margin-top: 12px; font-family: monospace; color: #0ff; }
    #sendBtn { margin-left: 8px; }
  </style>
</head>
<body>
  <h2>PickAI OCR Test Page</h2>
  <input type="file" id="file" accept="image/*">
  <button id="ocrBtn">OCR & Send</button>
  <button id="testBtn">Quick Test (2+3)</button>
  <div id="ocrResult"></div>
  <div id="answer"></div>

  <script>
    const fileEl = document.getElementById('file');
    const ocrBtn = document.getElementById('ocrBtn');
    const testBtn = document.getElementById('testBtn');
    const ocrResult = document.getElementById('ocrResult');
    const answer = document.getElementById('answer');

    ocrBtn.addEventListener('click', async () => {
      const f = fileEl.files[0];
      if (!f) return alert("이미지를 선택하세요");
      ocrResult.innerText = "OCR 중...";
      const worker = Tesseract.createWorker({
        logger: m => console.log('[TESSERACT]', m)
      });
      await worker.load();
      await worker.loadLanguage('eng');
      await worker.initialize('eng');
      const { data: { text } } = await worker.recognize(f);
      await worker.terminate();

      const cleaned = text.replace(/\n+/g, ' ').trim();
      ocrResult.innerText = "인식결과: " + cleaned;

      // post into page -> content.js catches and forwards
      window.postMessage({ source: "PICK_AI", type: "OCR_RESULT", text: cleaned }, "*");
    });

    testBtn.addEventListener('click', () => {
      const cleaned = "2+3";
      ocrResult.innerText = "인식결과: " + cleaned;
      window.postMessage({ source: "PICK_AI", type: "OCR_RESULT", text: cleaned }, "*");
    });

    // receive final answer from extension (content.js -> background -> content.js -> page)
    window.addEventListener("message", (e) => {
      if (e.data && e.data.type === "CHATGPT_ANSWER") {
        answer.innerText = "정답: " + e.data.answer;
      }
    });
  </script>
</body>
</html>
